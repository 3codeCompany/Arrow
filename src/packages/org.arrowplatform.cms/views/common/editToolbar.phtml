<html>

<head>
    <base href="http://<? print $_SERVER["HTTP_HOST"] . "/" . \Arrow\Router::getBasePath() ?>"/>
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-combined.min.css" rel="stylesheet">
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.3.min.js"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/jquery.ui/1.9.2/jquery-ui.js"></script>
    <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>


</head>

<body>


<div id="org-arrowplatform-cms-toolbar-container">
    <div class="navbar " id="cms-navbar" style="margin-bottom: 0px;">
        <div class="navbar-inner">
            <a class="brand" href="index" target="_parent">Strona: <?=$this["requested"]?></a>
            <ul class="nav" id="cms-nav-bar">
                <?if (!$this["page"]) { ?>
                    <li style="background: none;"><a href="o:cms::/createPage?rewrite=<?=$this["requested"]?>">Stwórz stronę</a></li>
                <? } else { ?>
                    <li <?if($this["editState"]){?>class="active"<?}?>><a class="switch-active-state" href="o:cms::/switch/page/switchEditionState" target="_parent"><i class="icon-pencil"></i> Włącz stan edycji</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                            Pliki
                            <b class="caret"></b>
                        </a>
                        <ul class="dropdown-menu">

                            <li><a href="#" class="use-files"><i class="icon-folder-open"></i> Przeglądaj pliki do użycia na stronie</a></li>
                            <li><a href="#" class="galleries"><i class="icon-picture"></i> Galerie na stronie</a></li>
                        </ul>
                    </li>
                    <li><a href="./admin" target="_parent"><i class="icon-circle-arrow-right"></i> Przejdź do panelu administracyjnego</a></li>
                    <li><a href="o:access:/auth/logout"><i class="icon-off"></i> Wyloguj</a></li>
                <? }?>
            </ul>
        </div>
    </div>
    <?if ($this["page"]) { ?>

        <div id="cms-tools-container">
                <?
                $data = new \Arrow\RequestContext(
                    array(
                         "model" => Arrow\Package\CMS\Page::getClass(),
                         "key"   => $this["page"]["id"],
                         "name"  => "files"
                    )
                );?>

            <div class="use-files container">
                <? print \Arrow\Models\Dispatcher::getDefault()->get("media::/plugins/manageObjectFiles")->fetch($data) ?>
                <div style="clear: both;"></div>
                <a href="" class="cms-tools-close-panel btn btn-mini">Skończyłem</a>
            </div>
            <div class="galleries container" style="padding-top: 5px;">
                <div class="navbar navbar-inverse">
                    <div class="navbar-inner" style="">
                        <form class="navbar-form pull-left">
                            <input type="text" class="span2">
                            <button type="submit" class="btn add-gallery">Dodaj</button>
                        </form>
                    </div>
                    <? $gals = \Arrow\ORM\Criteria::query(\Arrow\Package\CMS\Gallery::getClass())
                            ->c(\Arrow\Package\CMS\Gallery::F_PAGE_ID, $this["page"]["id"])
                            ->find();
                    ?>
                    <?if(!empty($gals)){?>
                    <table class="table">
                        <tr>
                            <th>Nazwa</th>
                        </tr>
                        <?foreach($gals as $gal){?>
                            <tr>
                                <td><?=$gal["name"]?></td>
                                <td>
                                    <a href="<?=$gal["id"]?>" class="gal-add-photos">zdjęcia</a>
                                    <div></div>
                                </td>
                                <td>
                                    <a href="<?=$gal["id"]?>" class="gal-edit">edytuj</a>
                                </td>
                                <!--<td><a href="">edytuj</a></td>-->
                                <td><a href="<?=$gal["id"]?>" class="remove-gallery">usuń</a></td>
                            </tr>
                        <?}?>
                    </table>
                <?}?>
                </div>


            </div>
        </div>
    <? }?>

</div>

<style>
    #cms-tools-container>div {
        display: none;
        margin-bottom: 5px;;
    }

    #usebox img, .cke_dialog_contents_body .cms-image img {
        max-width: 150px;
        max-height: 110px;

    }

    #usebox .cms-image, .cke_dialog_contents_body .cms-image {
        width: 170px;
        height: 125px;
        text-align: center;
        float: left;
        margin: 5px;
        background-color: #E8E8E8;
        padding: 3px;
        border-radius: 5px;
        border: solid 1px grey;
        position: relative;

    }

    #usebox .cms-image li {
        text-align: left;
    }

    .cke_dialog_contents_body .cms-image, .cke_dialog_contents_body .cms-image img {
        cursor: pointer;
    }


</style>

<script>
    var container = $("#org-arrowplatform-cms-toolbar-container");
    var iframe = window.parent.$("#org-arrowplatform-cms-toolbar-frame");
    function setFrameSize(add) {
        iframe.width("100%");
        var height = container.outerHeight() + 5;
        if (add && height < 40 + add)
            height += add;
        iframe.height(height);
    }

    $(".dropdown-toggle").click(function () {
        setFrameSize($(this).next().outerHeight());
    });

    $(function () {
        setFrameSize();

        $("#cms-nav-bar").find("a").click(function (e) {
            if ($(this).is(".dropdown-toggle"))
                return;

            if ($(this).attr("href") == "#")
                e.preventDefault();

            $("#cms-tools-container>div").hide();
            if ($(this).is(".add-files"))
                $('.add-files').show();

            if ($(this).is(".use-files")) {
                $('.use-files').show();
                orgArrowplatformMediavAlign();
            }

            if ($(this).is(".galleries")) {
                $('.galleries').show();

            }

            setFrameSize();
        });


        $(".cms-tools-close-panel").click(function (e) {
            e.preventDefault();
            $(this).parent().hide();
            setFrameSize();
        });

        $(".switch-active-state").click(function (e) {
            e.preventDefault();
            $.get($(this).attr("href"), function () {
                window.parent.location.reload()
            });
        });
        <?if(isset($this["page"]["id"])){?>
        $(".add-gallery").click(function (e) {
            e.preventDefault();
            var name = $(this).prev().val();
            if(name){
                //window.location.href = "o:cms::/gallery/create";

                $.post("o:cms::/gallery/create", {name: name, page: <?=$this["page"]["id"]?>},function(){
                    window.location.hash = "gallery";
                    window.location.reload();
                })
            }
        });
        <?}?>

        $(".remove-gallery").click(function (e) {
            e.preventDefault();
            $.post("o:cms::/gallery/remove", {key: $(this).attr("href")},function(){
                window.location.hash = "gallery";
                window.location.reload();
            })

        });

        if(window.location.hash == "#gallery"){
            $("a.galleries").click();
        }

        $(".gal-add-photos").click(function(e){
            e.preventDefault();

            var next = $(this).next();
            next.load("v:media::/plugins/manageObjectFiles?model=Arrow\\Package\\CMS\\Gallery&key="+$(this).attr("href")+"&name=file",setFrameSize);

        });

        $(".gal-edit").click(function(e){
            e.preventDefault();

            alert("aaa");
            /*var next = $(this).next();
            next.load("v:media::/plugins/manageObjectFiles?model=Arrow\\Package\\CMS\\Gallery&key="+$(this).attr("href")+"&name=file",setFrameSize);*/

        })


    })
</script>


</body>
</html>